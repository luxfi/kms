---
title: "Packer"
description: "Learn how to fetch secrets from KMS with Packer using a data source"
---

This guide demonstrates how to use the KMS Packer plugin to fetch secret data using a data source. The Packer plugin supports both [KMS Cloud](https://kms.lux.network) and [self-hosted instances of KMS](https://lux.network/docs/self-hosting/overview).

## Prerequisites

Before you begin, make sure you have:

- [Packer](https://developer.hashicorp.com/packer/install) installed
- An KMS account with access to a project
- Basic understanding of Packer

## Project Setup

### Configure Provider

First, specify the KMS provider in your Packer configuration:

```hcl
packer {
  required_plugins {
    kms = {
      source  = "github.com/kms/kms"
      version = ">=0.0.1"
    }
  }
}
```

### Authentication

Using a Machine Identity, you can authenticate with [Universal Auth](https://lux.network/docs/documentation/platform/identities/universal-auth).

```hcl
data "kms-secrets" "dev-secrets" {
  folder_path = "/"
  env_slug    = "dev" # The environment to list secrets from (e.g. dev, staging, prod)
  project_id  = "00000000-0000-0000-0000-000000000000"
  host        = "https://kms.lux.network" # Optional for cloud, required for self-hosted

  universal_auth {
    client_id = "00000000-0000-0000-0000-000000000000"
    client_secret = "..." # Optional if using KMS_UNIVERSAL_AUTH_CLIENT_SECRET env variable
  }
}
```

Learn more about [machine identities](/documentation/platform/identities/machine-identities).

## Using Secrets in Packer

You're able to fetch secrets from KMS using the `kms-secrets` Data Source:

```hcl
# Fetch all secrets from a folder
data "kms-secrets" "dev-secrets" {
  folder_path = "/"
  env_slug    = "dev"
  project_id  = "00000000-0000-0000-0000-000000000000"

  universal_auth {
    ...
  }
}

locals {
  secrets = data.kms-secrets.dev-secrets.secrets
}

source "null" "basic-example" {
  communicator = "none"
}

build {
  sources = [
    "source.null.basic-example"
  ]

  provisioner "shell-local" {
    inline = [
      "echo secret_key: ${local.secrets["SECRET_KEY"].secret_value}",
    ]
  }
}
```

The `local.secrets` object maps secret keys to [secret objects](https://github.com/KMS/packer-plugin-kms/blob/main/docs/datasources/secrets.md#secret-object).

See also:
- [Packer Plugin Repository Example](https://github.com/KMS/packer-plugin-kms/blob/main/example/build.pkr.hcl)
- [Packer Plugin Repository Docs](https://github.com/KMS/packer-plugin-kms/tree/main/docs)
- [Machine Identity setup guide](/documentation/platform/identities/machine-identities)
